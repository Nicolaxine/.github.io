<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0c11">
  <link rel="shortcut icon" href="http://freenicox.free.fr/Nicolaxine/faviconBoite.ico" title="Nicolaxine" />
  <link rel="icon" type="image/gif" href="http://freenicox.free.fr/Nicolaxine/faviconBoite.gif" />
  <title>NICOLAXINE — LECTEUR DE BADGE v2</title>

  <!-- Tesseract.js pour reconnaissance texte (OCR) -->
  <script src="https://unpkg.com/tesseract.js@v5.1.0/dist/tesseract.min.js"></script>

  <style>
    :root {
      --fond: #0a0c11;
      --panneau: #141821;
      --vert-heegrek: #40e070;
      --vert-fonce-heegrek: #2e7d32;
      --jaune-hiksse: #f4c430;
      --jaune-fonce-hiksse: #c29e26;
      --glow-green: rgba(64, 224, 112, 0.6);
      --glow-yellow: rgba(244, 196, 48, 0.6);
      --texte: #e8f5e9;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      height: 100dvh;
      background: var(--fond);
      color: var(--texte);
      font-family: monospace;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    header {
      height: 60px;
      background: var(--panneau);
      border-bottom: 1px solid var(--vert-heegrek);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      letter-spacing: 2px;
      color: var(--vert-heegrek);
      text-shadow: 0 0 10px var(--glow-green);
      flex-shrink: 0;
    }

    .container {
      flex: 1;
      position: relative;
    }

    #video, #overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #overlay { pointer-events: none; }

    #scan-bar {
      position: absolute;
      left: 0;
      width: 100%;
      height: 6px;
      background: linear-gradient(to right, transparent, var(--vert-heegrek), transparent);
      box-shadow: 0 0 20px var(--glow-green);
      animation: scan-down 5s linear infinite;
      pointer-events: none;
    }

    @keyframes scan-down {
      0% { top: -10px; }
      100% { top: 100%; }
    }

    #info {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,26,15,0.88);
      border: 1px solid var(--vert-heegrek);
      border-radius: 8px;
      padding: 14px 28px;
      font-size: 1.4rem;
      color: var(--vert-heegrek);
      text-shadow: 0 0 10px var(--glow-green);
      text-align: center;
      min-width: 340px;
      z-index: 10;
    }

    #overlay-message {
      position: fixed;
      inset: 0;
      background: rgba(10,12,17,0.96);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-size: 3rem;
      font-weight: 600;
      text-align: center;
      padding: 40px;
    }

    #overlay-message.visible {
      display: flex;
    }

    #overlay-message.heegrek { color: var(--vert-heegrek); text-shadow: 0 0 20px var(--glow-green); }
    #overlay-message.hiksse { color: var(--jaune-hiksse); text-shadow: 0 0 20px var(--glow-yellow); }
  </style>
</head>
<body>

  <header>NICOLAXINE — LECTEUR DE BADGE SÉCURISÉ v2</header>

  <div class="container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
    <div id="scan-bar"></div>
    <div id="info">PRÉSENTEZ VOTRE BADGE DEVANT LA CAMÉRA</div>
    <div id="overlay-message">ACCÈS AUTORISÉ</div>
  </div>

  <script>
    const video = document.getElementById('video');
    const info = document.getElementById('info');
    const overlayMsg = document.getElementById('overlay-message');

    let worker = null;

    // Initialiser Tesseract
    async function initTesseract() {
      worker = await Tesseract.createWorker('fra', 1, {
        workerPath: 'https://unpkg.com/tesseract.js@v5.1.0/dist/worker.min.js',
        langPath: 'https://tessdata.projectnaptha.com/4.0.0',
        corePath: 'https://unpkg.com/tesseract.js-core@v5.1.0/tesseract-core.wasm.js',
      });
      info.textContent = "LECTEUR PRÊT — PRÉSENTEZ BADGE";
    }

    // Démarrer caméra
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
      .then(stream => {
        video.srcObject = stream;
        initTesseract();
      })
      .catch(err => info.textContent = "Caméra refusée : " + err.message);

    video.addEventListener('play', () => {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
      const ctx = canvas.getContext('2d');

      setInterval(async () => {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Zone centrale agrandie
        const sampleSize = 220;
        const centerX = Math.floor(canvas.width / 2);
        const centerY = Math.floor(canvas.height / 2);
        const roi = ctx.getImageData(centerX - sampleSize/2, centerY - sampleSize/2, sampleSize, sampleSize);

        // 1. Détection couleur (tolérant)
        let greenScore = 0;
        let yellowScore = 0;
        const data = roi.data;

        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i+1];
          const b = data[i+2];

          // Vert Heegrek : g dominant, tolérant
          if (g > 120 && g > r * 1.2 && g > b * 1.2) greenScore++;
          // Jaune Hiksse : r/g équilibrés, b faible
          if (r > 150 && g > 130 && Math.abs(r - g) < 80 && b < 110) yellowScore++;
        }

        const total = sampleSize * sampleSize;
        const greenPct = greenScore / total;
        const yellowPct = yellowScore / total;
        console.log("Green % :", greenPct.toFixed(2), "Yellow % :", yellowPct.toFixed(2));

        // 2. OCR si couleur suffisante
        let ocrText = "";
        if (greenPct > 0.20 || yellowPct > 0.20) {
          try {
            const { data: { text } } = await worker.recognize(roi);
            ocrText = text.toUpperCase().replace(/\s+/g, '');
            console.log("Texte détecté :", ocrText);
          } catch (err) {
            console.error("OCR échoué :", err);
          }
        }

        // 3. Décision : couleur + texte tolérant
        if ((greenPct > 0.20 && (ocrText.includes("HEEGREG") || ocrText.includes("PROFESSEUR"))) || ocrText.includes("HEEGREK")) {
          info.textContent = "BADGE DÉTECTÉ — PR. HEEGREK — NIVEAU 4";
          info.style.color = 'var(--vert-heegrek)';
          showAuthorized("PR. HEEGREK — ACCÈS NIVEAU 4 CONFIRMÉ", 'var(--vert-heegrek)');
        }
        else if ((yellowPct > 0.20 && (ocrText.includes("HIKSSE") || ocrText.includes("DOCTEUR"))) || ocrText.includes("HIKSSE")) {
          info.textContent = "BADGE DÉTECTÉ — DR. HIKSSE — NIVEAU 3";
          info.style.color = 'var(--jaune-hiksse)';
          showAuthorized("DR. HIKSKSSE — ACCÈS NIVEAU 3 CONFIRMÉ", 'var(--jaune-hiksse)');
        }
      }, 600); // plus rapide pour feedback
    });

    function showAuthorized(message, color) {
      overlayMsg.textContent = message;
      overlayMsg.style.color = color;
      overlayMsg.classList.add('visible');

      // Bip autorisation
      const audio = new AudioContext();
      const osc = audio.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(1200, audio.currentTime);
      osc.frequency.linearRampToValueAtTime(800, audio.currentTime + 0.3);
      const gain = audio.createGain();
      osc.connect(gain);
      gain.connect(audio.destination);
      gain.gain.setValueAtTime(0.25, audio.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audio.currentTime + 0.6);
      osc.start();
      osc.stop(audio.currentTime + 0.6);

      setTimeout(() => {
        overlayMsg.classList.remove('visible');
        setTimeout(() => {
          window.location.href = "http://freenicox.free.fr/Nicolaxine/ApplicationNicolaxine/Carte_Portail_Tri-DimensionnelOK.html";
        }, 1500);
      }, 3000);
    }
  </script>
</body>
</html>